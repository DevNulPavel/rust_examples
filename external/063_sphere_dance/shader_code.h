#version 330 core
const int f=80;const float v=1280,z=720;uniform vec4 sp[(f+2)*2];uniform sampler2D terrain;in vec4 gl_FragCoord;out vec4 fragColor;const float e=99999.;vec2 p[4]=vec2[4](normalize(vec2(.23,.65)),normalize(vec2(.83,-.26)),normalize(vec2(.13,-.83)),normalize(vec2(-.2,.55)));vec3 t(vec3 v){float f=0.,i=0.;for(int z=0;z<4;z++){float e=v.x*p[z].x+v.z*p[z].y;e=e*(4.-float(z)*.51013)+sp[162].z;float s=1./(float(z)+1.);f+=s*sin(e-.3*cos(e));i+=s*cos(e-.3*sin(e));}return vec3(f,0.,i);}bool t(vec3 f,vec3 e,vec3 v,float z,out float i){vec3 y=v-e;float s=dot(y,f);if(s<0.)return false;else{float n=length(y),o=n*n-s*s;if(o>z)return false;else{float t=sqrt(z-o);i=s-t;return true;}}}float t(vec2 f,out float v){vec4 s=texture(terrain,f/512.);v=s.y;return s.x*60.-12.1;}void t(vec3 f,vec3 e,out float v,out float i){vec3 s=(vec3(0.)-f)/e,o=(vec3(512.)-f)/e;v=max(min(s.x,o.x),min(s.z,o.z));i=min(max(s.x,o.x),max(s.z,o.z));}bool t(vec3 v,vec3 f,out float i,out vec3 e,out vec3 o,out float z,out float s){float y,n;t(v,f,y,n);if(n<y)return false;float x=max(0.,y);v=v+x*f;vec2 m,r,d;d=sign(f.xz);r=1./f.xz*d;m=r*(max(d,0)-fract(v.xz)*d);if(any(isinf(m)||isinf(r)))return false;vec2 c=floor(v.xz);float p=v.y,u=t(c,s);z=0.;for(i=0.;i<n-x;){vec2 k=vec2(float(m.x<m.y),float(m.x>=m.y));i=dot(m,k);float g=v.y+f.y*i;c=c+d*k;m=m+r*k;if(u>g)return e=vec3(.2,.071,.01)+step(27,u)*vec3(.1,-.06,0),z=1.2,o=vec3(0,1.,0),i=(u-v.y)/f.y,true;u=t(c,s);if(u>g){z=1.5;e=vec3(.2,.2,.2)+step(40,u)*vec3(0.,-.03,-.1);if(s==1.){float a=25.31;if(g<a)s=0.;}o=vec3(-d.x*k.x,0,-d.y*k.y);return true;}}return false;}float t(float f,vec3 v,vec3 o){float e=(1.-f)/(1.+f);e*=e;float z=-dot(v,o),s=1.-z,i=e+(1.-e)*s*s*s*s*s;return i;}const vec3 i=vec3(5e-06,1.5e-05,.00027)*15.,o=vec3(.00015,.00015,.00027)*15.;vec3 n(float f){return exp(-f*(i+o));}vec3 n(float f,float s){float v=.0003/16.*3.14159*(1.+s*s);vec3 e=1./(i+o)*(1.-exp(-f*o));float z=.476;vec3 x=vec3(.002,.0008,.0002)*(1.-z)*(1.-z)/(12.5664*pow(1.+z*z-2.*z*s,1.5));float k=20./(i.x+o.x)*(1.-exp(-f*o.x));return v*e+x*k;}void main(){vec3 s=normalize(vec3(1.,1.1,1.));vec2 i=2.*(gl_FragCoord.xy/z)-vec2(v/z,1.);vec4 o=cos(sp[161]),d=sin(sp[161]);mat3 x=mat3(o.y,0,-d.y,-d.x*d.y,o.x,-d.x*o.y,o.x*d.y,d.x,o.y*o.x);vec3 m=x*vec3(i,-2.),y=sp[160].xyz;m+=y;vec3 r=normalize(m-y);float k=1.;vec3 c=vec3(0);for(int u=2;u>0;u--){vec3 p,g,a,b;float w,l=0.,C=e;for(int F=0;F<f;F++){float D;if(t(r,y,sp[F*2].xyz,sp[F*2].w,D)){if(D<C)C=D,a=y+C*r,g=normalize(a-sp[F*2].xyz),b=sp[F*2+1].xyz,w=sp[F*2+1].w,l=t(w,g,r);}}float F;vec3 D,q;float h;if(t(y,r,F,D,q,w,h)){if(F<C){if(h==1.){float Z=25.91;vec3 Y=(y-vec3(386.,Z,447.))*512.;float X;if(t(Y,r*512,X,D,q,w,h))C=F+X/512.,b=D,b.z=b.z*2.;else{C=F*2.02;y=y+r*C;continue;}}else C=F,b=D;g=q;a=y+r*C*.9999;l=t(w,g,r);}}F=(-.5-y.y)/r.y;if(r.y<0.&&F<=C){a=y+r*F*.9999;g=vec3(0.,1.f,0.f)+t(a)*.01;g=normalize(g);l=t(1.1,g,r);vec3 Z=refract(r,g,1.-l);b=vec3(.05,.05,.15);if(t(a,Z*100,F,D,q,w,h))b+=D*exp(-F*40.);}p=reflect(normalize(r),g);if(C>=e){c+=n(C,dot(s,r))*k;break;}bool Z=t(a,s,F,D,q,w,h);if(!Z){for(int Y=0;Y<f;Y++){if(t(s,a,sp[Y*2].xyz,sp[Y*2].w,F)){Z=true;break;}}}if(!Z){float Y=dot(s,g);vec3 X=normalize(s-r);float W=pow(dot(g,X),121.);W=clamp(W,0.,1.);D=vec3(W)+b*Y;}else D=b*.02;D*=n(C);D+=n(C,dot(s,r));c+=D*k*(1.-l);k=k*l;r=p;y=a;}fragColor=vec4(pow(c,vec3(1./2.2)),1.);}