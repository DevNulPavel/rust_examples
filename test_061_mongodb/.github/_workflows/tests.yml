name: Docker publish
on:
    workflow_dispatch:
        branches:
            - main
    push:
        branches:
            - main
env:
    DOCKER_LOGIN: ${{ secrets.DOCKER_LOGIN }}
    DOCKER_ACCESS_TOKEN: ${{ secrets.DOCKER_ACCESS_TOKEN }}
jobs:
    # Push image to GitHub Packages.
    # See also https://docs.docker.com/docker-hub/builds/
    # https://docs.docker.com/ci-cd/github-actions/
    build_and_push:
        runs-on: ubuntu-latest
        steps:
            - name: Check Out Repo 
              uses: actions/checkout@v2

            - name: Login to Docker Hub
              uses: docker/login-action@v1
              with:
                username: ${{ secrets.DOCKERHUB_LOGIN }}
                password: ${{ secrets.DOCKERHUB_ACCESS_TOKEN }}

            - name: Set up Docker Buildx
              id: buildx
              uses: docker/setup-buildx-action@v1

            - name: Build and push
              id: docker_build
              uses: docker/build-push-action@v2
              with:
                context: ./
                file: ./dockerfile
                push: true
                tags: devnul/pocket_telegram_bot:latest

            - name: Image digest
              run: echo ${{ steps.docker_build.outputs.digest }}

    deploy:
        runs-on: ubuntu-latest
        needs: build_and_push
        steps:
            - name: Deploy at server
              uses: appleboy/ssh-action@v0.1.3
              with:
                host: ${{ secrets.SERVER_HOST }}
                username: ${{ secrets.SERVER_USERNAME }}
                key: ${{ secrets.SERVER_SSH_KEY }}
                script: |
                    cd docker_pocket_telegram_bot
                    echo "${{ secrets.DOCKERHUB_ACCESS_TOKEN }}" | docker login -u ${{ secrets.DOCKERHUB_LOGIN }} --password-stdin
                    docker-compose stop
                    docker-compose rm -f
                    docker-compose pull
                    docker-compose up -d

